<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>piecewise-regression &mdash; piecewise-regression 1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="#" class="icon icon-home"> piecewise-regression
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">piecewise-regression</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
      <li>piecewise-regression</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="piecewise-regression">
<h1>piecewise-regression<a class="headerlink" href="#piecewise-regression" title="Permalink to this headline"></a></h1>
<p>Easy to use piecewise regression (aka segmented regression) in Python. For fitting straight lines to data where there is one or more changes in gradient (known as breakpoints). Based on Muggeo “Estimating regression models with unknown break-points” (2003). For example:</p>
<img alt="basic-example-plot-github" src="https://raw.githubusercontent.com/chasmani/piecewise-regression/master/paper/example.png" />
</section>
<section id="installation">
<h1>Installation<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h1>
<p>You can install piecewise-regression using python’s <a class="reference external" href="https://pypi.org/project/piecewise-regression/">pip package index</a></p>
<blockquote>
<div><p>pip install piecewise-regression</p>
</div></blockquote>
<p>The package was developed and tested on Python 3.7.</p>
</section>
<section id="getting-started">
<h1>Getting started<a class="headerlink" href="#getting-started" title="Permalink to this headline"></a></h1>
<p>The package requires some x and y data to fit. You also need to specify either a) some initial breakpoint guesses as <cite>start_values</cite> or b) how many breakpoints you want to fit as <cite>n_breakpoints</cite> (or both). Here is a very simple example, assuming we already have some data <cite>x</cite> and <cite>y</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">piecewise_regression</span>
<span class="n">pw_fit</span> <span class="o">=</span> <span class="n">piecewise_regression</span><span class="o">.</span><span class="n">Fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">n_breakpoints</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">pw_fit</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="example">
<h1>Example<a class="headerlink" href="#example" title="Permalink to this headline"></a></h1>
<p>Here is a more detailed example. We start off generating some data with a breakpoint. This is for demonstration purposes, normally you will have your own data to fit:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">piecewise_regression</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">alpha_1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
<span class="n">alpha_2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">breakpoint_1</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">n_points</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">xx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">n_points</span><span class="p">)</span>
<span class="n">yy</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">alpha_1</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha_2</span><span class="o">-</span><span class="n">alpha_1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">breakpoint_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">n_points</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we fit the model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given some data, fit the model</span>
<span class="n">pw_fit</span> <span class="o">=</span> <span class="n">Fit</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">start_values</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">n_breakpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Print a summary of the fit</span>
<span class="n">pw_fit</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
<p>Example output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                    <span class="n">Breakpoint</span> <span class="n">Regression</span> <span class="n">Results</span>
<span class="o">====================================================================================================</span>
<span class="n">No</span><span class="o">.</span> <span class="n">Observations</span>                      <span class="mi">200</span>
<span class="n">No</span><span class="o">.</span> <span class="n">Model</span> <span class="n">Parameters</span>                    <span class="mi">4</span>
<span class="n">Degrees</span> <span class="n">of</span> <span class="n">Freedom</span>                    <span class="mi">196</span>
<span class="n">Res</span><span class="o">.</span> <span class="n">Sum</span> <span class="n">of</span> <span class="n">Squares</span>               <span class="mf">193.264</span>
<span class="n">Total</span> <span class="n">Sum</span> <span class="n">of</span> <span class="n">Squares</span>              <span class="mf">46201.8</span>
<span class="n">R</span> <span class="n">Squared</span>                        <span class="mf">0.995817</span>
<span class="n">Adjusted</span> <span class="n">R</span> <span class="n">Squared</span>               <span class="mf">0.995731</span>
<span class="n">Converged</span><span class="p">:</span>                           <span class="kc">True</span>
<span class="o">====================================================================================================</span>
<span class="o">====================================================================================================</span>
                    <span class="n">Estimate</span>      <span class="n">Std</span> <span class="n">Err</span>            <span class="n">t</span>        <span class="n">P</span><span class="o">&gt;|</span><span class="n">t</span><span class="o">|</span>       <span class="p">[</span><span class="mf">0.025</span>       <span class="mf">0.975</span><span class="p">]</span>
<span class="o">----------------------------------------------------------------------------------------------------</span>
<span class="n">const</span>                <span class="mf">100.726</span>        <span class="mf">0.244</span>       <span class="mf">413.63</span>     <span class="mf">3.1e-290</span>       <span class="mf">100.25</span>       <span class="mf">101.21</span>
<span class="n">alpha1</span>              <span class="o">-</span><span class="mf">4.21998</span>       <span class="mf">0.0653</span>      <span class="o">-</span><span class="mf">64.605</span>    <span class="mf">4.37e-134</span>      <span class="o">-</span><span class="mf">4.3488</span>      <span class="o">-</span><span class="mf">4.0912</span>
<span class="n">beta1</span>                <span class="mf">2.18914</span>       <span class="mf">0.0689</span>       <span class="mf">31.788</span>            <span class="o">-</span>       <span class="mf">2.0533</span>        <span class="mf">2.325</span>
<span class="n">breakpoint1</span>          <span class="mf">6.48706</span>        <span class="mf">0.137</span>            <span class="o">-</span>            <span class="o">-</span>       <span class="mf">6.2168</span>       <span class="mf">6.7573</span>
<span class="o">----------------------------------------------------------------------------------------------------</span>
<span class="n">These</span> <span class="n">alphas</span><span class="p">(</span><span class="n">gradients</span> <span class="n">of</span> <span class="n">segments</span><span class="p">)</span> <span class="n">are</span> <span class="n">estimated</span> <span class="kn">from</span> <span class="nn">betas</span><span class="p">(</span><span class="n">change</span> <span class="ow">in</span> <span class="n">gradient</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------------------------------------</span>
<span class="n">alpha2</span>              <span class="o">-</span><span class="mf">2.03084</span>       <span class="mf">0.0218</span>      <span class="o">-</span><span class="mf">93.068</span>    <span class="mf">3.66e-164</span>      <span class="o">-</span><span class="mf">2.0739</span>      <span class="o">-</span><span class="mf">1.9878</span>
<span class="o">====================================================================================================</span>

<span class="n">Davies</span> <span class="n">test</span> <span class="k">for</span> <span class="n">existence</span> <span class="n">of</span> <span class="n">at</span> <span class="n">least</span> <span class="mi">1</span> <span class="n">breakpoint</span><span class="p">:</span> <span class="n">p</span><span class="o">=</span><span class="mf">5.13032e-295</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">p</span><span class="o">&lt;</span><span class="mf">0.05</span> <span class="n">means</span> <span class="n">reject</span> <span class="n">null</span> <span class="n">hypothesis</span> <span class="n">of</span> <span class="n">no</span> <span class="n">breakpoints</span> <span class="n">at</span> <span class="mi">5</span><span class="o">%</span> <span class="n">significance</span><span class="p">)</span>
</pre></div>
</div>
<p>This includes estimates for all the model variables, along with confidence intervals. The Davies test is a hypothesis test for the existence of at least one breakpoint, against the null hypothesis of no breakpoints.</p>
<p>There are also tools for plotting data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Plot the data, fit, breakpoints and confidence intervals</span>
<span class="n">pw_fit</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1"># Pass in standard matplotlib keywords to control any of the plots</span>
<span class="n">pw_fit</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">pw_fit</span><span class="o">.</span><span class="n">plot_breakpoints</span><span class="p">()</span>
<span class="n">pw_fit</span><span class="o">.</span><span class="n">plot_breakpoint_confidence_intervals</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<img alt="fit-example-plot" src="_images/example2.png" />
<p>You can extract data as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the key results of the fit</span>
<span class="n">pw_results</span> <span class="o">=</span> <span class="n">pw_fit</span><span class="o">.</span><span class="n">get_results</span><span class="p">()</span>
<span class="n">pw_estimates</span> <span class="o">=</span> <span class="n">pw_results</span><span class="p">[</span><span class="s2">&quot;estimates&quot;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="how-it-works">
<h1>How It Works<a class="headerlink" href="#how-it-works" title="Permalink to this headline"></a></h1>
<p>The package implements Muggeo’s iterative algorithm (Muggeo “Estimating regression models with unknown break-points” (2003)), to quickly find breakpoints. That method simultaneously fits breakpoint positions and the linear models for the different segments of the fit. This method is quick and it gives confidence intervals for all the model estimates. See the accompanying paper for more details.</p>
<p>Muggeo’s method doesn’t always converge on the best solution - sometimes it finds a locally optimal solution or doesn’t converge at all. For this reason the Fit method also implements a process called bootstrap restarting. This involves taking a bootstrap resample of the data, then using this bootstrapped data to try and find a better solution. The number of times this runs can be controlled with <cite>n_boot</cite>. To run the Fit without bootstrap restarting, set <cite>n_boot=0</cite>.</p>
<p>If you don’t have good guesses for inital breakpoints, you can just set the number of e.g. <cite>n_breakpoints=3</cite>. in this case the algorithm will randomly generate starting breakpoints until it finds a solution that converges (up to <cite>n_boot</cite> times). This is a good option if the algorithm is otherwise not converging.</p>
</section>
<section id="model-selection">
<h1>Model Selection<a class="headerlink" href="#model-selection" title="Permalink to this headline"></a></h1>
<p>in addition to the main Fit tool, the package also offers a <cite>ModelSelection</cite> option based on the Bayesian Information Criterion. This is experimental and not as thorough as the main Fit tool:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span> <span class="o">=</span> <span class="n">ModelSelection</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">max_breakpoints</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
<p>This gives the following example output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                 <span class="n">Breakpoint</span> <span class="n">Model</span> <span class="n">Comparision</span> <span class="n">Results</span>
<span class="o">====================================================================================================</span>
<span class="n">n_breakpoints</span>            <span class="n">BIC</span>    <span class="n">converged</span>          <span class="n">RSS</span>
<span class="o">----------------------------------------------------------------------------------------------------</span>
<span class="mi">0</span>                     <span class="mf">421.09</span>         <span class="kc">True</span>       <span class="mf">1557.4</span>
<span class="mi">1</span>                     <span class="mf">14.342</span>         <span class="kc">True</span>       <span class="mf">193.26</span>
<span class="mi">2</span>                     <span class="mf">22.825</span>         <span class="kc">True</span>       <span class="mf">191.23</span>
<span class="mi">3</span>                     <span class="mf">24.169</span>         <span class="kc">True</span>       <span class="mf">182.59</span>
<span class="mi">4</span>                     <span class="mf">29.374</span>         <span class="kc">True</span>       <span class="mf">177.73</span>
<span class="mi">5</span>                                   <span class="kc">False</span>
<span class="mi">6</span>                                   <span class="kc">False</span>

<span class="n">Minimum</span> <span class="n">BIC</span> <span class="p">(</span><span class="n">Bayesian</span> <span class="n">Information</span> <span class="n">Criterion</span><span class="p">)</span> <span class="n">suggests</span> <span class="n">the</span> <span class="n">best</span> <span class="n">model</span>
</pre></div>
</div>
</section>
<section id="testing">
<h1>Testing<a class="headerlink" href="#testing" title="Permalink to this headline"></a></h1>
<p>The package includes comprehensive tests.</p>
<p>To run all tests, from the main directory run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">-</span><span class="n">m</span> <span class="s2">&quot;nose&quot;</span>
</pre></div>
</div>
<p>Note: This requires nosetests, can be downloaded from apt with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">nose</span>
</pre></div>
</div>
<p>There are also a series of simulation tests that check the estimates have realistic confidence intervals, and the Davies test gives realistic p-values. These can be found in the folder “tests”.</p>
</section>
<section id="documentation">
<h1>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline"></a></h1>
<p><a class="reference external" href="https://piecewise-regression.readthedocs.io/en/latest/">Full docs, including an API reference.</a></p>
<div class="toctree-wrapper compound">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#main">Main</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#model-selection">Model selection</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html#davies-test">Davies test</a></li>
</ul>
</li>
</ul>
</div>
</section>
<section id="indices-and-tables">
<h1>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline"></a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api.html" class="btn btn-neutral float-right" title="API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Charlie Pilgrim.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>